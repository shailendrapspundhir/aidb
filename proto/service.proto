syntax = "proto3";

package aidb;

// aiDB gRPC Service for multi-model database
// Unified layer for SQL (DataFusion), NoSQL (JSON/Serde in Sled), Vectors (HNSW)
// Supports hybrid queries with predicate push-down for performance.

service AiDbService {
  // Auth & Management
  rpc Register (RegisterRequest) returns (RegisterResponse);
  rpc Login (LoginRequest) returns (LoginResponse);
  rpc CreateTenant (CreateTenantRequest) returns (CreateTenantResponse);
  rpc CreateEnvironment (CreateEnvironmentRequest) returns (CreateEnvironmentResponse);
  rpc CreateCollection (CreateCollectionRequest) returns (CreateCollectionResponse);

  // Insert metadata (as Arrow internally) and vector into storage
  rpc Insert (InsertRequest) returns (InsertResponse);
  // Insert full NoSQL Document (JSON for unstructured/flexible schema)
  rpc InsertDoc (InsertDocRequest) returns (InsertResponse);
  // Text-based search (placeholder)
  rpc Search (SearchRequest) returns (SearchResponse);
  // Vector-based ANN search using HNSW index
  rpc VectorSearch (VectorSearchRequest) returns (SearchResponse);
  // Execute SQL query on projected Arrow data (from NoSQL JSON)
  // Enables structured queries on docs table (e.g., SELECT * FROM docs WHERE category='AI')
  rpc ExecuteSql (SqlRequest) returns (SqlResponse);
  // Hybrid search: SQL filter + vector similarity (push-down optimized)
  // e.g., category filter on SQL + ANN for max perf without data movement
  rpc HybridSearch (HybridRequest) returns (HybridResponse);
}

message RegisterRequest { string username = 1; string password = 2; }
message RegisterResponse { bool success = 1; }
message LoginRequest { string username = 1; string password = 2; }
message LoginResponse { string token = 1; }

message CreateTenantRequest { string id = 1; string name = 2; }
message CreateTenantResponse { bool success = 1; }
message CreateEnvironmentRequest { string tenant_id = 1; string id = 2; string name = 3; }
message CreateEnvironmentResponse { bool success = 1; }
message CreateCollectionRequest { string env_id = 1; string id = 2; string name = 3; }
message CreateCollectionResponse { bool success = 1; }

message InsertRequest {
  string id = 1;
  string text = 2;  // Metadata text, converted to Arrow RecordBatch
  repeated float vector = 3;  // Embedding vector stored in Sled
  string collection_id = 4;
}

message InsertDocRequest {
  string id = 1;
  string text = 2;
  string category = 3;  // For SQL filtering
  repeated float vector = 4;
  string metadata_json = 5;  // Flexible NoSQL JSON blob (Serde)
  string collection_id = 6;
}

message InsertResponse {
  bool success = 1;
}

message SearchRequest {
  string query = 1;
  string collection_id = 2;
}

message VectorSearchRequest {
  repeated float query_vector = 1;  // Query embedding
  uint32 top_k = 2;  // Number of nearest neighbors
  string collection_id = 3;
}

message SqlRequest {
  string sql = 1;  // SQL query on 'docs' table (DataFusion)
  string collection_id = 2;
}

message SqlResponse {
  // Serialized Arrow IPC for results (vectorized SQL output)
  bytes arrow_data = 1;
}

message HybridRequest {
  string sql_filter = 1;  // SQL predicate (e.g., "category = 'AI'")
  repeated float query_vector = 2;  // For vector ANN
  uint32 top_k = 3;
  string collection_id = 4;
}

message HybridResponse {
  repeated string results = 1;  // Doc IDs or serialized JSON
  repeated bool cache_hits = 2; // True if doc fetched from cache
  // Extend with full docs for NoSQL return
}

message SearchResponse {
  repeated string results = 1;  // IDs of matching documents
}